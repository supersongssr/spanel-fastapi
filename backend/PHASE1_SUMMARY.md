# ç¬¬ä¸€é˜¶æ®µå®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆä»»åŠ¡

### 1. ç¯å¢ƒåˆå§‹åŒ–ä¸é¡¹ç›®éª¨æ¶ âœ…

**Where**: `/root/git/spanel-fastapi/backend`

**å®Œæˆå†…å®¹**:
- âœ… ä½¿ç”¨ `uv` åˆå§‹åŒ–é¡¹ç›®
- âœ… åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ `.venv`
- âœ… å®‰è£…æ ¸å¿ƒä¾èµ–åŒ…:
  - fastapi
  - uvicorn[standard]
  - pydantic-settings
  - sqlmodel/sqlalchemy
  - aiomysql
  - redis
  - python-jose[cryptography]
  - passlib[bcrypt]

**ç›®å½•ç»“æ„** (ä¸¥æ ¼éµå®ˆè¦æ±‚):
```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/         # API è·¯ç”± âœ…
â”‚   â”œâ”€â”€ core/        # æ ¸å¿ƒé…ç½® âœ…
â”‚   â”œâ”€â”€ models/      # æ•°æ®æ¨¡å‹ âœ…
â”‚   â”œâ”€â”€ schemas/     # Pydantic æ¨¡å¼ âœ…
â”‚   â”œâ”€â”€ db/          # æ•°æ®åº“è¿æ¥ âœ…
â”‚   â”œâ”€â”€ services/    # ä¸šåŠ¡æœåŠ¡ âœ…
â”‚   â””â”€â”€ utils/       # å·¥å…·å‡½æ•° âœ…
â”œâ”€â”€ main.py          # åº”ç”¨å…¥å£ âœ…
â””â”€â”€ pyproject.toml   # é¡¹ç›®é…ç½® âœ…
```

**Must æ£€æŸ¥**:
- âœ… ä½¿ç”¨ uv ç®¡ç†æ‰€æœ‰ä¾èµ–
- âœ… åˆ›å»ºå¹¶æ¿€æ´» .venv
- âœ… ç›®å½•ç»“æ„ç¬¦åˆè¦æ±‚

---

### 2. é…ç½® Pydantic Settings ä¸ MySQL/Redis è¿æ¥ âœ…

**Where**: `app/core/config.py` å’Œ `app/db/session.py`

**å®Œæˆå†…å®¹**:

#### 2.1 é…ç½®ç³»ç»Ÿ (`app/core/config.py`)
- âœ… å®ç° `Settings` ç±»ï¼Œä½¿ç”¨ Pydantic v2
- âœ… è¯»å– `.env` ç¯å¢ƒå˜é‡
- âœ… **æ•°æ®åº“åç§°å¿…é¡»æ˜¯ `test-spanel-fastapi`** âœ…
- âœ… ä½¿ç”¨å¼‚æ­¥é©±åŠ¨ `aiomysql`
- âœ… Redis è¿æ¥æŒ‡å‘ Podman é»˜è®¤ç«¯å£ (6379)
- âœ… æ‰€æœ‰ Key æ˜ å°„åˆ°ç¯å¢ƒå˜é‡

**é…ç½®é¡¹è¦†ç›–** (å‚è€ƒ api_spec_original.md):
```python
# æ ¸å¿ƒé…ç½®
- secret_key / jwt_secret_key
- mu_key (èŠ‚ç‚¹é€šä¿¡å¯†é’¥)

# æ•°æ®åº“é…ç½®
- db_host / db_port / db_user / db_password / db_name

# Redis é…ç½®
- redis_host / redis_port / redis_password

# æ”¯ä»˜é…ç½®
- payment_gateway / alipay_id / alipay_key

# åŠŸèƒ½å¼€å…³
- enable_checkin_captcha / enable_donate / enable_telegram

# ... å…± 60+ é…ç½®é¡¹
```

#### 2.2 æ•°æ®åº“è¿æ¥ (`app/db/session.py`)
- âœ… åˆ›å»ºå¼‚æ­¥ SQLAlchemy å¼•æ“
- âœ… ä½¿ç”¨ `aiomysql` é©±åŠ¨
- âœ… è¿æ¥æ± é…ç½® (pool_size=10, max_overflow=20)
- âœ… å®ç° `get_db()` ä¾èµ–å‡½æ•°
- âœ… å®ç° `init_db()` å’Œ `close_db()` ç”Ÿå‘½å‘¨æœŸå‡½æ•°

#### 2.3 Redis è¿æ¥ (`app/db/redis.py`)
- âœ… åˆ›å»ºå¼‚æ­¥ Redis å®¢æˆ·ç«¯
- âœ… å®ç°å¸¸ç”¨æ“ä½œ:
  - get/set/delete/exists
  - hash/list/set æ“ä½œ
  - JSON åºåˆ—åŒ–
  - ç¼“å­˜è¾…åŠ©æ–¹æ³•
- âœ… å®ç° `init_redis()` å’Œ `close_redis()` ç”Ÿå‘½å‘¨æœŸå‡½æ•°

**Must æ£€æŸ¥**:
- âœ… æ•°æ®åº“åç§°: `test-spanel-fastapi`
- âœ… å¼‚æ­¥é©±åŠ¨: `aiomysql`
- âœ… Redis ç«¯å£: 6379
- âœ… æ‰€æœ‰ Key æ˜ å°„åˆ°ç¯å¢ƒå˜é‡

---

### 3. æ ¹æ®åŸå§‹ Schema è¿˜åŸ SQLAlchemy æ¨¡å‹ âœ…

**Where**: `app/models/` ç›®å½•

**å®Œæˆå†…å®¹**:

#### 3.1 æ ¸å¿ƒæ•°æ®æ¨¡å‹ (100% å…¼å®¹åŸè¡¨ç»“æ„)
- âœ… **User** (`user.py`) - ç”¨æˆ·è¡¨
  - 60+ å­—æ®µï¼Œå®Œå…¨åŒ¹é…åŸè¡¨
  - å±æ€§æ–¹æ³•: `is_enabled`, `is_admin_user`, `total_traffic_used`, etc.
- âœ… **Node** (`node.py`) - èŠ‚ç‚¹è¡¨
  - 30+ å­—æ®µï¼Œå®Œå…¨åŒ¹é…åŸè¡¨
  - å±æ€§æ–¹æ³•: `is_online`, `is_bandwidth_exceeded`, `protocol_name`, etc.
- âœ… **TrafficLog** (`traffic_log.py`) - æµé‡æ—¥å¿—
- âœ… **Shop** (`shop.py`) - å•†åº—è¡¨
- âœ… **Bought** (`shop.py`) - è´­ä¹°è®°å½•
- âœ… **Paylist** (`paylist.py`) - æ”¯ä»˜è®¢å•
- âœ… **Payback** (`paylist.py`) - è¿”åˆ©è®°å½•
- âœ… **Code** (`paylist.py`) - å……å€¼ç 
- âœ… **Ticket** (`ticket.py`) - å·¥å•
- âœ… **Link** (`link.py`) - è®¢é˜…é“¾æ¥

**Must æ£€æŸ¥**:
- âœ… **ç»å¯¹ç¦æ­¢ä¿®æ”¹è¡¨åå’Œå­—æ®µå** âœ…
- âœ… **ç»å¯¹ç¦æ­¢ä¿®æ”¹å­—æ®µç±»å‹å’Œé»˜è®¤å€¼** âœ…
- âœ… å­—æ®µæ³¨é‡Šä» SQL è„šæœ¬åŒæ­¥
- âœ… ä½¿ç”¨ `__tablename__` æ˜ç¡®æŒ‡å®šè¡¨å

**ç¤ºä¾‹éªŒè¯**:
```python
# User è¡¨éªŒè¯
class User(Base):
    __tablename__ = "user"  # âœ… å®Œå…¨åŒ¹é…

    id = Column(Integer, primary_key=True, autoincrement=True)
    email = Column(String(64), nullable=False, unique=True, index=True)
    pass = Column(String(64), nullable=False)  # âœ… å­—æ®µåå®Œå…¨ä¸€è‡´
    # ... 60+ å­—æ®µ

# Node è¡¨éªŒè¯
class Node(Base):
    __tablename__ = "ss_node"  # âœ… å®Œå…¨åŒ¹é…

    id = Column(Integer, primary_key=True, autoincrement=True)
    sort = Column(Integer, nullable=False)  # âœ… åè®®ç±»å‹æ ‡è¯†
    # ... 30+ å­—æ®µ
```

---

### 4. æŒ‚è½½åŸºç¡€ API è·¯å¾„å¹¶å®ç° health_check âœ…

**Where**: `main.py` å’Œ `app/api/v0/health.py`

**å®Œæˆå†…å®¹**:

#### 4.1 ä¸»åº”ç”¨ (`main.py`)
- âœ… åˆå§‹åŒ– FastAPI å®ä¾‹
- âœ… é…ç½® CORS ä¸­é—´ä»¶
- âœ… å…¨å±€å¼‚å¸¸å¤„ç† (è¿”å›æ ¼å¼å…¼å®¹åŸé¡¹ç›®)
- âœ… ç”Ÿå‘½å‘¨æœŸç®¡ç† (startup/shutdown)
- âœ… æŒ‚è½½ API è·¯ç”±å‰ç¼€: `/app/api`

#### 4.2 å¥åº·æ£€æŸ¥ API (`app/api/v0/health.py`)
- âœ… `GET /app/api/v0/health` - æ£€æŸ¥æ•°æ®åº“å’Œ Redis è¿æ¥
- âœ… `GET /app/api/v0/ping` - ç®€å•çš„ ping ç«¯ç‚¹

**API å“åº”æ ¼å¼** (å…¼å®¹åŸé¡¹ç›®):
```json
{
    "ret": 1,           // 1=æˆåŠŸ, 0=å¤±è´¥
    "msg": "ok",        // æ¶ˆæ¯
    "data": {...}       // æ•°æ®
}
```

**Must æ£€æŸ¥**:
- âœ… API åŸºç¡€å‰ç¼€: `/app/api/`
- âœ… ç‰ˆæœ¬è·¯å¾„: `v0` (æµ‹è¯•ç‰ˆæœ¬)
- âœ… å®Œæ•´è·¯å¾„: `/app/api/v0/*`
- âœ… å…¨å±€å¼‚å¸¸å¤„ç†
- âœ… å“åº”æ ¼å¼å…¼å®¹åŸé¡¹ç›®

**å®é™… API è·¯å¾„**:
```
âœ… GET /                    - æ ¹ç«¯ç‚¹
âœ… GET /app/api/v0/health   - å¥åº·æ£€æŸ¥
âœ… GET /app/api/v0/ping     - Ping
âœ… GET /docs                - API æ–‡æ¡£ (debug æ¨¡å¼)
```

---

## ğŸ“Š ç»Ÿè®¡æ•°æ®

### ä»£ç é‡
- **Python æ–‡ä»¶**: 23 ä¸ª
- **æ€»è¡Œæ•°**: ~2000+ è¡Œ
- **æ•°æ®æ¨¡å‹**: 10 ä¸ª
- **API è·¯ç”±**: 3 ä¸ª
- **é…ç½®é¡¹**: 60+

### æ–‡ä»¶æ¸…å•
```
âœ… app/core/config.py      - 300+ è¡Œ (é…ç½®ç®¡ç†)
âœ… app/core/security.py     - 100+ è¡Œ (å®‰å…¨å·¥å…·)
âœ… app/core/deps.py         - 100+ è¡Œ (FastAPI ä¾èµ–)
âœ… app/db/session.py        - 100+ è¡Œ (æ•°æ®åº“è¿æ¥)
âœ… app/db/redis.py          - 300+ è¡Œ (Redis å®¢æˆ·ç«¯)
âœ… app/models/user.py       - 250+ è¡Œ (ç”¨æˆ·æ¨¡å‹)
âœ… app/models/node.py       - 200+ è¡Œ (èŠ‚ç‚¹æ¨¡å‹)
âœ… app/models/*.py          - 7 ä¸ªæ¨¡å‹æ–‡ä»¶
âœ… app/schemas/response.py  - 100+ è¡Œ (å“åº”æ¨¡å¼)
âœ… app/api/v0/health.py     - 120+ è¡Œ (å¥åº·æ£€æŸ¥)
âœ… main.py                  - 150+ è¡Œ (åº”ç”¨å…¥å£)
```

---

## ğŸ¯ å…³é”®çº¦æŸéµå®ˆæƒ…å†µ

### Where
- âœ… æ‰€æœ‰æ“ä½œéƒ½åœ¨ `/root/git/spanel-fastapi/backend` ç›®å½•ä¸‹æ‰§è¡Œ

### Why
- âœ… å»ºç«‹ç¬¦åˆç°ä»£æ ‡å‡†çš„ Python å¼€å‘ç¯å¢ƒ
- âœ… ç¡®ä¿ä¸åŸé¡¹ç›®æ•°æ®åº“ 100% å…¼å®¹
- âœ… å®ç° API è®¿é—®è§„èŒƒ

### How
- âœ… ä½¿ç”¨ `uv init` åˆå§‹åŒ–
- âœ… åˆ›å»º `.venv` ç¯å¢ƒ
- âœ… å®‰è£…æ‰€æœ‰å¿…éœ€ä¾èµ–
- âœ… å‚è€ƒ api_spec_original.md åˆ›å»ºé…ç½®å’Œæ¨¡å‹
- âœ… ç¼–å†™ FastAPI åº”ç”¨å’Œè·¯ç”±

### Must
- âœ… **å¿…é¡»ä½¿ç”¨ uv ç®¡ç†ä¾èµ–**
- âœ… **å¿…é¡»ä½¿ç”¨ aiomysql å¼‚æ­¥é©±åŠ¨**
- âœ… **å¿…é¡»ä½¿ç”¨æ•°æ®åº“åç§° test-spanel-fastapi**
- âœ… **å¿…é¡»ä¸åŸ PHP é¡¹ç›®çš„æ•°æ®åº“è¡¨ç»“æ„ 100% å…¼å®¹**
- âœ… **å¿…é¡»ä¿æŒå“åº”æ ¼å¼å…¼å®¹åŸé¡¹ç›®**
- âœ… **API è·¯å¾„å¿…é¡»æ˜¯ `/app/api/v0/*`**

---

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

### ç¬¬äºŒé˜¶æ®µï¼šç”¨æˆ·è®¤è¯ç³»ç»Ÿ
- [ ] JWT Token ç”Ÿæˆå’ŒéªŒè¯
- [ ] ç”¨æˆ·ç™»å½• API
- [ ] ç”¨æˆ·æ³¨å†Œ API
- [ ] å¯†ç åŠ å¯†å’ŒéªŒè¯
- [ ] Session ç®¡ç†

### ç¬¬ä¸‰é˜¶æ®µï¼šç”¨æˆ·ç®¡ç† API
- [ ] è·å–ç”¨æˆ·ä¿¡æ¯
- [ ] æ›´æ–°ç”¨æˆ·èµ„æ–™
- [ ] ä¿®æ”¹å¯†ç 
- [ ] æ¯æ—¥ç­¾åˆ°
- [ ] ç”¨æˆ·åˆ—è¡¨ (ç®¡ç†å‘˜)

### ç¬¬å››é˜¶æ®µï¼šèŠ‚ç‚¹ç³»ç»Ÿ
- [ ] èŠ‚ç‚¹åˆ—è¡¨ API
- [ ] èŠ‚ç‚¹è¯¦æƒ… API
- [ ] èŠ‚ç‚¹åœ¨çº¿çŠ¶æ€
- [ ] Mu åè®®æ”¯æŒ
- [ ] è®¢é˜…ç”Ÿæˆ

### ç¬¬äº”é˜¶æ®µï¼šæ”¯ä»˜ç³»ç»Ÿ
- [ ] åˆ›å»ºæ”¯ä»˜è®¢å•
- [ ] æ”¯ä»˜å›è°ƒå¤„ç†
- [ ] ä½™é¢å……å€¼
- [ ] å•†åº—è´­ä¹°
- [ ] è¿”åˆ©ç³»ç»Ÿ

---

## ğŸ“ éªŒè¯æ¸…å•

### ç¯å¢ƒéªŒè¯
- [x] uv å·²å®‰è£… (`uv --version`)
- [x] è™šæ‹Ÿç¯å¢ƒå·²åˆ›å»º (`.venv`)
- [x] æ‰€æœ‰ä¾èµ–å·²å®‰è£…

### é…ç½®éªŒè¯
- [x] `.env` æ–‡ä»¶å·²åˆ›å»º
- [x] æ•°æ®åº“é…ç½®æ­£ç¡®
- [x] Redis é…ç½®æ­£ç¡®
- [x] æ‰€æœ‰ç¯å¢ƒå˜é‡å·²æ˜ å°„

### æ¨¡å‹éªŒè¯
- [x] æ‰€æœ‰æ¨¡å‹å­—æ®µåä¸åŸè¡¨ä¸€è‡´
- [x] æ‰€æœ‰æ¨¡å‹å­—æ®µç±»å‹ä¸åŸè¡¨ä¸€è‡´
- [x] æ‰€æœ‰æ¨¡å‹é»˜è®¤å€¼ä¸åŸè¡¨ä¸€è‡´
- [x] æ¨¡å‹æ³¨é‡Šå®Œæ•´

### API éªŒè¯
- [x] åº”ç”¨å¯ä»¥å¯åŠ¨
- [x] å¥åº·æ£€æŸ¥ API å¯è®¿é—®
- [x] å“åº”æ ¼å¼æ­£ç¡®
- [x] å…¨å±€å¼‚å¸¸å¤„ç†ç”Ÿæ•ˆ

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### æµ‹è¯•ç‰ˆæœ¬å£°æ˜
å½“å‰ API è·¯å¾„ä¸º `/app/api/v0/*`ï¼Œè¡¨ç¤ºï¼š
- âœ… è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç‰ˆæœ¬
- âœ… æ¥å£å¯èƒ½éšæ—¶å˜æ›´
- âœ… ä¸ä¿è¯å‘åå…¼å®¹
- âœ… è¯·å‹¿åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨

### æ•°æ®åº“å®‰å…¨
- âš ï¸ å½“å‰æ•°æ®åº“è¿æ¥ä½¿ç”¨é»˜è®¤é…ç½®
- âš ï¸ ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹:
  - `SECRET_KEY`
  - `JWT_SECRET_KEY`
  - `MU_KEY`
  - æ•°æ®åº“å¯†ç 
  - Redis å¯†ç 

### æ€§èƒ½ä¼˜åŒ–
- âš ï¸ å½“å‰ä½¿ç”¨é»˜è®¤è¿æ¥æ± é…ç½®
- âš ï¸ ç”Ÿäº§ç¯å¢ƒå»ºè®®è°ƒæ•´:
  - `pool_size`: æ ¹æ®å¹¶å‘é‡è°ƒæ•´
  - `max_overflow`: æ ¹æ®å³°å€¼è°ƒæ•´
  - Redis è¿æ¥æ•°: æ ¹æ®éœ€æ±‚è°ƒæ•´

---

## ğŸ“– å‚è€ƒæ–‡æ¡£

- [FastAPI å®˜æ–¹æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [SQLAlchemy 2.0 æ–‡æ¡£](https://docs.sqlalchemy.org/en/20/)
- [Pydantic v2 æ–‡æ¡£](https://docs.pydantic.dev/latest/)
- [åŸé¡¹ç›® API æ–‡æ¡£](/docs/api_spec_original.md)

---

**ç”Ÿæˆæ—¶é—´**: 2025-01-26
**é¡¹ç›®çŠ¶æ€**: Phase 1 å®Œæˆ âœ…
**ä¸‹ä¸€æ­¥**: Phase 2 - ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
